<!DOCTYPE html>
<meta charset="utf-8">

<html>
<head>
<title> TCG Scene Builder </title>
<link rel="shortcut icon", href="TCG.ico">
<link rel="stylesheet" href="scene_builder.css" type="text/css">
</head>

<body>

<div id="title">
<img id="icon" src="TCG.ico" alt="TCG icon" style="width:32px;height:32px" align="left">
<h1>Scene Builder</h1>
</div>

<div id="scene_input">
<div id="scene_fig">
	<svg id="fig_svg">
		<defs>
			<marker id="arrow" markerWidth="13" markerHeight="13" refx="2" refy="6" orient="auto">
				<path d="M2,2 L2,11 L10,6 L2,2" style="fill:red;" />
			</marker>
		</defs>
	</svg>
</div>
<div id="forms">
<div id="add_schema">
<form method="POST" action="" id="schema_form">
	<div class="section_title">ADD PERCEPTUAL SCHEMA</div>
	<fieldset>
		<legend>NAME:</legend>
		<div><label class="field" for="schema_nameField">Name:</label><input type="text" id="schema_nameField" name="schema_nameField" value="Schema_0" /></div>
	</fieldset>
	<fieldset>
		<legend>AREA:</legend>
		<div>
			<label class="field" for="x_Field">x:</label><input type="text" class="num_val" id="x_Field" name="x_Field" value="0" />
			<label class="field" for="y_Field">y:</label><input type="text" class="num_val" id="y_Field" name="y_Field" value="0" />
			<label class="field" for="width_Field">w:</label><input type="text" class="num_val" id="width_Field" name="width_Field" value="0" />
			<label class="field" for="height_Field">h:</label><input type="text" class="num_val" id="height_Field" name="height_Field" value="0" />
		</div>
	</fieldset>
	<fieldset>
		<legend>PERCEPTUAL PARAMETERS:</legend>
		<div>
			<label class="field" for="saliency_Field">Saliency:</label><input type="text" class="num_val" id="saliency_Field" name="saliency_Field" value="auto" />
			<label class="field" for="uncertainty_Field">Uncertainty:</label><input type="text" class="num_val" id="uncertainty_Field" name="uncertainty_Field" value="1" />
		</div>
	</fieldset>
	<fieldset>
		<legend> SELECT SCHEMA TYPE:</legend>
		<div id="type_list">
			<select id="type_select" onchange="set_schema_field(this.value)">
				<option>OBJECT</option>
				<option>RELATION</option>
				<option>ACTION</option>
			</select>
		</div>
	</fieldset>
	<fieldset id="schema_field">
		<legend>SELECT SCHEMA:</legend>
		<div id="schema_list">
			<select id="schema_select">
			</select>
		</div>
	</fieldset>
	<div class="save-reset"><button type="submit" onclick="submit_schema_form_data()">Add schema</button><button type="button" onclick="reset_schema_form()">Reset form</button></div>
</form>
</div>

<div id="add_subscene">
<form method="POST" action="" id="subscene_form">
	<div class="section_title">BUILD SUBSCENE</div>
	<fieldset>
		<legend>NAME:</legend>
		<div><label class="field" for="subscene_nameField">Name:</label><input type="text" id="subscene_nameField" name="subscene_nameField" value="Subscene_0" /></div>
	</fieldset>
	<fieldset>
		<legend>ADD SCHEMA:</legend>
		<div id="scene_schemas"></div>
		<div id="schema_list">
			<select id="schema_select" multiple="yes">
			</select>
		</div>
	</fieldset>
	<div class="save-reset"><button type="submit" onclick="submit_subscene_form_data()">Add subscene</button><button type="button" onclick="reset_subscene_form()">Reset form</button></div>
</form>
</div>
</div>
</div>

<div id="scene_content">
<div class="section_title">SCENE CONTENT</div>
<div id="defined_schemas">
</div>
<div id="defined_subscenes">
</div>
</div>
<div class="save-reset">
<p><button id="reset" onclick="reset_scene()">RESET ALL</button></p>
<p><button id="generate_data" onclick="generate_data()">Generate scene data</button></p>
</div>
<div id="save_data"></div>

<script src="./js/jquery-1.11.2.min.js"></script>
<script>
//My data
var xmlns = "http://www.w3.org/2000/svg" //SVG XML namspace.
var xlink = "http://www.w3.org/1999/xlink"
var height = 400;
var scale = 0 // Stores the scaling factor.
var scene = {image:"scene.png", resolution:[], schemas:{}, subcenes:[]}; // Stores all the regions informations for the given scene.
var schema2fig = {}; //Stores correspondence table between schema id and fig id.
var fig2schema = {}; //Stores correspondence table between fig id and schema id.

var SCHEMA_COUNT = 0;
var SUBSCENCE_COUNT = 0; 

var RELATIONS = ['RELATION']; // The schema types that define relations.

var schema_form_clone = $("#schema_form").clone();//Keeps a version of the original schema form.
var subscene_form_clone = $("#subscene_form").clone();//Keeps a version of the original subscene form.

///////////////////
///Display image///
///////////////////
dispSceneImage();
get_native_resolution();
//Drawing regions
initDraw(document.getElementById("fig_svg"));
disp_schemas();

/**
 * Display the scene image.
 */
function dispSceneImage(){
	var mySVG = document.getElementById("fig_svg");
	mySVG.setAttribute("xmlns", xmlns);
	mySVG.setAttribute("xmlns:xlink", xlink);
	
	var myImg = document.createElementNS(xmlns, "image");
	myImg.setAttribute("id", "scene_img");
	mySVG.appendChild(myImg);
};

/**
 * Get image native resolution and rescales.
 * Opens the image without displaying it.
 */
function get_native_resolution(){
	var img = new Image();
	img.onload = function(){
		var img_width  = this.width;
        var img_height = this.height;
		scene.resolution = [img_width, img_height];
		//rescale image
		scale = height/img_height;
		var myImg = document.getElementById("scene_img");
		myImg.setAttributeNS(xlink, "xlink:href", scene["image"]);
		myImg.setAttribute("x", 0);
		myImg.setAttribute("y", 0);
		myImg.setAttribute("width", scene["resolution"][0]*scale);
		myImg.setAttribute("height", scene["resolution"][1]*scale);
		
		var mySVG = document.getElementById("fig_svg");
		mySVG.setAttribute("width", scene["resolution"][0]*scale);
		mySVG.setAttribute("height", scene["resolution"][1]*scale);
		
		};
	img.src = scene["image"];
};

/////////////////////////////
///Display defined schemas///
/////////////////////////////
/**
 * For all the schemas defined and stored in scene.schemas -> Display schemas information.
 */
function disp_schemas(){
	var section = document.getElementById("defined_schemas");
	while (section.firstChild) {
		section.removeChild(section.firstChild);
	};
	for(var i in scene.schemas){
		var sc = scene.schemas[i];
		var aDiv = document.createElement("div");
		aDiv.id = i;
		aDiv.setAttribute("class",  "schema");
		aDiv.setAttribute("onclick", "expand_schema(this)");
		if(!(is_rel(sc["type"]))){
			aDiv.setAttribute("onmouseover", "highlight(schema2fig[this.id], 'area')");
			aDiv.setAttribute("onmouseout", "dim(schema2fig[this.id], 'area')");
		}
		else{
			aDiv.setAttribute("onmouseover", "highlight(schema2fig[this.id], 'arrow')");
			aDiv.setAttribute("onmouseout", "dim(schema2fig[this.id], 'arrow')");
		};
		section.appendChild(aDiv);
		
		var subDiv = document.createElement("div");
		subDiv.setAttribute("class", "schema_info");
		subDiv.innerHTML = sc.name  + ": " + sc.schema + " (" + sc.type + ")";
		aDiv.appendChild(subDiv);
		
		//Add display fig checkbox
		var disp_checkbox = document.createElement("input");
		subDiv.appendChild(disp_checkbox);
		disp_checkbox.setAttribute("class", "disp_checkbox");
		disp_checkbox.innerHTML = "Delete Region";
		disp_checkbox.setAttribute("type","checkbox");
		disp_checkbox.setAttribute("value",i);
	};
	
	//disp updated schema figs
	disp_figs();
};

/**
 * Show all schema info.
 */
function expand_schema(obj){
	// Get schema data
	var data = scene.schemas[obj.id];
	 
	var details = document.createElement("div");
	details.setAttribute("class", "schema_details");
	obj.appendChild(details);
	
	//Location & Size
	var area_div = document.createElement("div");
	details.appendChild(area_div);
	var area_data = "Loc: (" + data.location.join(", ") + ") ; Size: (" + data.size.join(", ")+ ")";
	area_div.innerHTML = area_data;
	//Saliency
	var sal_div = document.createElement("div");
	details.appendChild(sal_div);
	sal_div.innerHTML = "Saliency: "+ data.saliency;
	//Uncertainty
	var uncert_div = document.createElement("div");
	details.appendChild(uncert_div);
	uncert_div.innerHTML = "Uncertainty: " + data.uncertainty;
	//Schema data
	expand_schema_data(details, data);
	//Delete button
	var del_button = document.createElement("button");
	details.appendChild(del_button);
	del_button.innerHTML = "Delete schema";
	del_button.setAttribute("onclick","del_schema("+ obj.id +")");
	//Reset onclick
	obj.setAttribute("onclick", "reduce_schema(this)");
};

/**
 * Show all perceptual schemas informations.
 */
function expand_schema_data(obj, data){
	var type_div = document.createElement("div");
	obj.appendChild(type_div)
	type_div.innerHTML = "Type: " + data["type"];
	
	var schema_div = document.createElement("div");
	obj.appendChild(schema_div)
	schema_div.innerHTML = "schema: " + data["schema"];
	
	if(is_rel(data["type"])){
		var from_to_div = document.createElement("div");
		obj.appendChild(from_to_div)
		type_div.innerHTML = "From: " + data["from"] + ", To: " + data["to"];
	};
	
};

/**
 * Show only basic schema info.
 */
function reduce_schema(obj){
	var children = obj.children;
	for(var i=0; i<children.length; i++){
		if(children[i].className == "schema_details"){
			obj.removeChild(children[i])
			obj.setAttribute("onclick", "expand_schema(this)");
			break;
		};
	};
};

/**
 * Delete a schema and its associated fig.
 */
function del_schema(id){
	var sc = document.getElementById(id);
	var fig = document.getElementById(schema2fig[id]);
	delete schema2fig[id];
	delete fig2schema[fig.id];
	delete scene.schemas[id];
	sc.remove();
	fig.remove();
	disp_schemas();
};
////////////////////////////////////
///Handling schemas figs on image///
////////////////////////////////////
/**
* Draw a fig
* @param {svg element} svg.
*/
function initDraw(fig_svg) {
    function setMousePosition(e) {
        var ev = e || window.event; //Moz || IE
        if (ev.pageX) { //Moz
            mouse.x = ev.pageX + window.pageXOffset;
            mouse.y = ev.pageY + window.pageYOffset;
        } else if (ev.clientX) { //IE
            mouse.x = ev.clientX + document.body.scrollLeft;
            mouse.y = ev.clientY + document.body.scrollTop;
        }
    };

    var mouse = {
        x: 0,
        y: 0,
        startX: 0,
        startY: 0
    };
    var element = null;
	
	var fig_rect = document.getElementById("fig_svg").getBoundingClientRect();
	console.log(fig_rect);

    fig_svg.onmousemove = function () {
        setMousePosition();
        if (element !== null) {
            element.setAttribute("width", Math.abs(mouse.x - fig_rect.left - mouse.startX) + 'px');
            element.setAttribute("height", Math.abs(mouse.y - fig_rect.top - mouse.startY) + 'px');
            element.setAttribute("x", (mouse.x - fig_rect.left - mouse.startX < 0) ? mouse.x - fig_rect.left+ 'px' : mouse.startX + 'px');
            element.setAttribute("y", (mouse.y  - fig_rect.top - mouse.startY < 0) ? mouse.y - fig_rect.top + 'px' : mouse.startY + 'px');
        }
    }

    fig_svg.onclick = function (e) {
        if (element !== null) {
			var rect = element.getBoundingClientRect();
			update_schema_form(Math.round((rect.top-fig_rect.top)/scale), Math.round((rect.left-fig_rect.left)/scale), Math.round(rect.width/scale), Math.round(rect.height/scale));
            element = null;
            fig_svg.style.cursor = "default";
            console.log("finsihed.");
        } else {
			$('.rectangle').remove();
            console.log("begun.");
            mouse.startX = mouse.x - fig_rect.left;
            mouse.startY = mouse.y - fig_rect.top;
            element = document.createElementNS(xmlns,'rect');
            element.setAttribute("class", 'rectangle');
			element.setAttribute("id", 'rectangle_' + SCHEMA_COUNT);
            element.setAttribute("x", mouse.x - fig_rect.left + 'px');
            element.setAttribute("y", mouse.y - fig_rect.top+ 'px');
            fig_svg.appendChild(element)
            fig_svg.style.cursor = "crosshair";
        }
    }
}

/**
* Display the schema area figs for all the schemas currently defined in scene.schemas object.
*/
function disp_figs(){
	$('.fig').remove(); // Start by deleting all the existing figs.
	var fig_svg = document.getElementById("fig_svg");
	var fig_rect = fig_svg.getBoundingClientRect();
	
	for(var i in scene.schemas){
			var schema = scene.schemas[i];
			if(!(is_rel(schema["type"]))){
			var fig = document.createElementNS(xmlns, "rect");
			fig.setAttribute("class", "fig area");
			fig.setAttribute("id", "fig_" + i);
			fig_svg.appendChild(fig);
			var loc = schema.location;
			var size = schema.size;
			//fig.style.position = "absolute";
			fig.setAttribute("y", loc[0]*scale + "px");
			fig.setAttribute("x", loc[1]*scale + "px");
			fig.setAttribute("width", size[0]*scale + "px");
			fig.setAttribute("height", size[1]*scale + "px");
			fig.setAttribute("onclick", "area_schema_expand(this, fig2schema[this.id])");
			fig.setAttribute("onmouseover", "highlight(this.id, 'area')");
			fig.setAttribute("onmouseout", "dim(this.id, 'area')");
		}
		else{
			var from_schema = scene.schemas[find_schema_id(schema["from"])];
			var to_schema = scene.schemas[find_schema_id(schema["to"])];
			
			var from_loc = from_schema.location;
			var from_size = from_schema.size;
			
			var to_loc = to_schema.location;
			var to_size = to_schema.size;
			
			var begin_pos = [from_loc[1]*scale + from_size[1]*scale*1/2, from_loc[0]*scale + from_size[0]*scale*1/2];
			var end_pos = [to_loc[1]*scale + to_size[1]*scale*1/2, to_loc[0]*scale + to_size[0]*scale*1/2];
			
			fig_svg = document.getElementById("fig_svg");
			draw_arrow(fig_svg, i, begin_pos, end_pos, schema.name);
		};
		schema2fig[i] = "fig_" + i; //Setting a correspondence table between reg id and fig id.
		fig2schema["fig_" + i] = i;
	};
};

/**
* Draws an arrow in the svg starting at begin_pos and ending at end_pos.
*/
function draw_arrow(fig_svg, id, begin_pos, end_pos){
	var arrow = document.createElementNS(xmlns, "path");
	fig_svg.appendChild(arrow);
	arrow.setAttribute("class", "fig arrow");
	arrow.setAttribute("id", "fig_" + id);
	arrow.setAttribute("d", "M" + begin_pos[0] + "," + begin_pos[1] + " L" + end_pos[0] + "," + end_pos[1]);
	arrow.setAttribute("style", "marker-end: url(#arrow);");
	arrow.setAttribute("onclick", "area_schema_expand(this, fig2schema[this.id])");
	arrow.setAttribute("onmouseover", "highlight(this.id, 'arrow')");
	arrow.setAttribute("onmouseout", "dim(this.id, 'arrow')");
};

/**
* Find the id for a given schema name.
*/
function find_schema_id(name){
	for(i in scene.schemas){
		if(scene.schemas[i]["name"] == name){
			return i;
		};
	};
	return -1;
};

/**
* Highlight fig and schemas when mouse over.
*/
function highlight(id, type){
	var myfig = document.getElementById(id);
	console.log(type);
	if(type == "area"){
		myfig.setAttribute("class", "fig highlight_area");
	}
	else if(type == "arrow"){
		myfig.setAttribute("class", "fig highlight_arrow");
	};
	var mySchema = document.getElementById(fig2schema[id]);
	mySchema.setAttribute("class", "highlight_schema");
};

/**
* Dims fig and schema when mouse out.
*/
function dim(id, type){
	var myfig = document.getElementById(id);
	if(type == "area"){
		myfig.setAttribute("class", "fig area");
	}
	else if(type == "arrow"){
		myfig.setAttribute("class", "fig arrow");
	};
	var mySchema = document.getElementById(fig2schema[id]);
	mySchema.setAttribute("class", "schema");
};

/**
* If schema not expanded, expand schema info when fig is clicked.
*/
function area_schema_expand(obj, id){
	reduce_schema(document.getElementById(id));
	expand_schema(document.getElementById(id));
	obj.setAttribute("onclick", "area_schema_reduce(this, fig2schema[this.id])");
};

/**
* If schema expanded, reduce schema info when fig is clicked.
*/
function area_schema_reduce(obj, id){
	reduce_schema(document.getElementById(id));
	obj.setAttribute("onclick", "area_schema_expand(this, fig2schema[this.id])");
};

//////////////////////////
///Handling schema form///
//////////////////////////
/**
* Update form x, y, w, h values based on the fig being drawn.
*/
function update_schema_form(startX, startY, width, height){
	document.getElementById("x_Field").setAttribute("value", startX);
	document.getElementById("y_Field").setAttribute("value", startY);
	document.getElementById("width_Field").setAttribute("value", width);
	document.getElementById("height_Field").setAttribute("value", height);
};

/**
* Updates the schema field based on the type of schema chosen
*/
function set_schema_field(type){
	var schema_field = document.getElementById("schema_field");
	if(!is_rel(type)){
		var from_to = document.getElementById("from_to");
		if(from_to){
		 from_to.remove()
		};
	}
	else{
		var from_to = document.createElement("div");
		from_to.setAttribute("id", "from_to");
		schema_field.appendChild(from_to);
		
		var from_div = document.createElement("div");
		from_to.appendChild(from_div);
		entry_name = document.createElement("div");
		from_div.appendChild(entry_name);
		entry_name.innerHTML = "From: "
		add_schema_select(from_div, "schema_from", false);
		
		var to_div = document.createElement("div");
		from_to.appendChild(to_div);
		entry_name = document.createElement("div");
		to_div.appendChild(entry_name);
		entry_name.innerHTML = "To: "
		add_schema_select(to_div, "schema_to", false);
	};
};

/**
* Returns true if the type belongs to RELATIONS.
*/
function is_rel(type){
	var is_rel = false;
	for(var i=0; i<RELATIONS.length; i++){
		if(RELATIONS[i]==type){
			is_rel = true;
		};
	};
	return is_rel
}

/**
* Adds a selection option of all existing perceptual schemas.
* @param:
*	obj: Object to which the selection should be added
*	id: id of the select object.
*	include_rel: if =true includes relation schemas, else only includes non relation schemas.
*/
function add_schema_select(obj, id, include_rel){
	var select = document.createElement("select");
	obj.appendChild(select);
	select.setAttribute("id", id);
	var sc = scene.schemas;
	for(var i in sc){
		if(include_rel || !(is_rel(sc[i]["type"]))){
			var opt = document.createElement("option");
			select.appendChild(opt);
			opt.innerHTML = sc[i]["name"];
		};
	};
};

/**
* Form submit function.
*/
function submit_schema_form_data(){
    // This will act when the submit BUTTON is clicked
    $("#schema_form").submit(function(event){
        event.preventDefault();
        var schema_data = build_schema_data();
		save_schema(schema_data)
		SCHEMA_COUNT +=1;
		reset_schema_form();
    });
};

/**
* Saves the schemas in "scene" once the schema form is submitted.
*/

function save_schema(data){
	var rect = document.getElementById('rectangle_' + SCHEMA_COUNT)
	if(rect) {
	 rect.remove();
	};
	scene.schemas[SCHEMA_COUNT] = data;
	disp_schemas();
}


/**
* Reset form
*/
function reset_schema_form(){
	$("#schema_form").replaceWith(schema_form_clone.clone());
	var elem = document.getElementById("schema_nameField");
	elem.setAttribute("value", "Schema_" + SCHEMA_COUNT);
}

/**
* Reset form
*/
function reset_subscene_form(){
	$("#subscene_form").replaceWith(subscene_form_clone.clone());
	var elem = document.getElementById("subscene_nameField");
	elem.setAttribute("value", "Subscene_" + SUBSCENCE_COUNT);
}

//////////////////
///Data handing///
//////////////////
/**
* This will generate a variable containing all the schema form data
*/
function build_schema_data(){
    var data = {};
	data["name"] = $("#schema_nameField").val();
	data["location"] = [Math.round($("#x_Field").val()), Math.round($("#y_Field").val())];
	data["size"] = [Math.round($("#width_Field").val()), Math.round($("#height_Field").val())];
    data["saliency"] = $("#saliency_Field").val();
	data["uncertainty"] = $("#uncertainty_Field").val();
	data["type"] = $("#type_select").val();
	data["schema"] = $("#schema_select").val();
	if(is_rel(data["type"])){
		data["from"] = $("#schema_from").val();
		data["to"] = $("#schema_to").val();
	}
    return data;
};

/**
* Allow user to download the data in JSON format.
*/
function generate_data(){
	var myScene = {"scene": scene};
	var data = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(myScene, null, ' '));
	$('<a href="data:' + data + '" download="TCG_scene.json" onclick="delete_save(this)">download JSON</a>').appendTo('#save_data');
};

function delete_save(obj){
	obj.remove();
}

/**
* Reset scene
*/
function reset_scene(){
	SCHEMA_COUNT = 0;
	SUBSCENCE_COUNT = 0;
	reset_schema_form();
	reset_subscene_form();
	img_rect = {};
	scene.schemas = {};
	disp_schemas();
}
</script>

</body>
</html>