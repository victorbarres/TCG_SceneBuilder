<!DOCTYPE html>
<meta charset="utf-8">

<html>
<head>
<title> TCG Scene Builder </title>
<link rel="shortcut icon", href="TCG.ico">
<link rel="stylesheet" href="scene_builder.css" type="text/css">
</head>

<div id="title">
<img id="icon" src="TCG.ico" alt="TCG icon" style="width:32px;height:32px" align="left">
<h1>Scene Builder</h1>
</div>

<body>
<div id="scene_input">
<div id="scene_pic"></div>
<div id="forms">
<div id="add_schema">
<form method="POST" action="" id="schema_form">
	<div class="section_title">ADD PERCEPTUAL SCHEMA</div>
	<fieldset>
		<legend>NAME:</legend>
		<div><label class="field" for="rgn_nameField">Name:</label><input type="text" id="rgn_nameField" name="rgn_nameField" value="Schema_0" /></div>
	</fieldset>
	<fieldset>
		<legend>AREA:</legend>
		<div>
			<label class="field" for="x_Field">x:</label><input type="text" class="num_val" id="x_Field" name="x_Field" value="0" />
			<label class="field" for="y_Field">y:</label><input type="text" class="num_val" id="y_Field" name="y_Field" value="0" />
			<label class="field" for="width_Field">w:</label><input type="text" class="num_val" id="width_Field" name="width_Field" value="0" />
			<label class="field" for="height_Field">h:</label><input type="text" class="num_val" id="height_Field" name="height_Field" value="0" />
		</div>
	</fieldset>
	<fieldset>
		<legend>PERCEPTUAL PARAMETERS:</legend>
		<div>
			<label class="field" for="saliency_Field">Saliency:</label><input type="text" class="num_val" id="saliency_Field" name="saliency_Field" value="auto" />
			<label class="field" for="uncertainty_Field">Uncertainty:</label><input type="text" class="num_val" id="uncertainty_Field" name="uncertainty_Field" value="1" />
		</div>
	</fieldset>
	<fieldset>
		<legend> SELECT SCHEMA TYPE:</legend>
		<div id="type_list">
			<select id="type_select">
			</select>
		</div>
	</fieldset>
	<fieldset style="visibility: hidden; display: none">
		<legend>SELECT SCHEMA:</legend>
		<div id="schema_list">
			<select class="schema_select">
			</select>
		</div>
	</fieldset>
	<div class="save-reset"><button type="submit" onclick="submit_form_data()">Add schema</button><button type="button" onclick="reset_form()">Reset form</button></div>
</form>
</div>

<div id="add_subscene">
<form method="POST" action="" id="subscene_form">
	<div class="section_title">BUILD SUBSCENE</div>
	<fieldset>
		<legend>NAME:</legend>
		<div><label class="field" for="rgn_nameField">Name:</label><input type="text" id="rgn_nameField" name="rgn_nameField" value="Subscene_0" /></div>
	</fieldset>
	<fieldset>
		<legend>ADD SCHEMA:</legend>
		<div id="scene_schemas"></div>
		<div id="schema_list">
			<select id="schema_select" multiple="yes">
			</select>
		</div>
	</fieldset>
	<div class="save-reset"><button type="submit" onclick="submit_form_data()">Add subscene</button><button type="button" onclick="reset_form()">Reset form</button></div>
</form>
</div>
</div>
</div>

<div id="scene_content">
<div class="section_title">SCENE CONTENT</div>
<div id="defined_schemas">
<div class="section_title">PERCEPTUAL SCHEMAS</div>
</div>
<div id="defined_subscenes">
<div class="section_title">SUBSCENES</div>
</div>
</div>
<div class="save-reset">
<p><button id="reset" onclick="reset_scene()">RESET ALL</button></p>
<p><button id="generate_data" onclick="generate_data()">Generate scene data</button></p>
</div>
<div id="save_data"></div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script>
//My data
var scale = 0.5;
var img_rect = {};
var scene = {image:"scene.png", resolution:[], schemas:[], subcenes:[]}; // Stores all the regions informations for the given scene.
var schema2mask = {}; //Stores correspondence table between schema id and mask id.
var mask2schema = {}; //Stores correspondence table between mask id and schema id.

var schema_form_clone = $("#schema_form").clone();//Keeps a version of the original schema form.
var subscene_form_clone = $("#subcene_form").clone();//Keeps a version of the original subscene form.

///////////////////
///Display image///
///////////////////
dispSceneImage();
get_native_resolution();
//Drawing regions
initDraw(document.getElementById("canvas"));
dispRegions();

/**
 * Display the scene image.
 */
function dispSceneImage(){
	var scene_div = document.getElementById("scene_pic");
	var mySVG = document.createElement("svg");
	mySVG.setAttribute("id", "canvas");
	scene_div.appendChild(mySVG);
	var myImg = document.createElement("img");
	myImg.setAttribute("id", "scene_img");
	mySVG.appendChild(myImg);
};

/**
 * Get image native resolution and rescales.
 * Opens the image without displaying it.
 */
function get_native_resolution(){
	var img = new Image();
	img.onload = function(){
		var img_width  = this.width;
        var img_height = this.height;
		scene.resolution = [img_width, img_height];
		//rescale image
		var myImg = document.getElementById("scene_img");
		myImg.setAttribute("src", scene["image"]);
		myImg.setAttribute("width", scene["resolution"][0]*scale);
		myImg.setAttribute("height", scene["resolution"][1]*scale);
	}
	img.src = scene["image"];
}

/////////////////////////////
///Display defined regions///
/////////////////////////////
/**
 * For all the regions defined and stored in scene.regions -> Display region information.
 * Updates regions masks on the image.
 */
function disp_schemas(){
	var section = document.getElementById("defined_schemas");
	while (reg_section.firstChild) {
		reg_section.removeChild(reg_section.firstChild);
	};
	for(var i=0; i<scene.regions.length; i++){
		var aReg = scene.regions[i];
		var reg_div = document.createElement("div");
		reg_div.id = i;
		reg_div.setAttribute("class",  "reg");
		reg_div.setAttribute("onclick", "expand_reg(this)");
		reg_div.setAttribute("onmouseover", "highlight_area(reg2mask[this.id])");
		reg_div.setAttribute("onmouseout", "dim_area(reg2mask[this.id])");
		reg_section.appendChild(reg_div);
		
		var name = aReg.name;
		name_div = document.createElement("div");
		name_div.setAttribute("class", "reg_name");
		name_div.innerHTML = name;
		reg_div.appendChild(name_div);
	};
	
	//disp updated img masks
	disp_masks();
};

/**
 * Show all schema info.
 */
function expand_schema(obj){
	// Get schema data
	var data = scene.schemas[obj.id];
	 
	var details = document.createElement("div");
	details.setAttribute("class", "schemas_details");
	obj.appendChild(details);
	
	//Location & Size
	var area_div = document.createElement("div");
	details.appendChild(area_div);
	var area_data = "Loc: (" + data.location.join(", ") + ") ; Size: (" + data.size.join(", ")+ ")";
	area_div.innerHTML = area_data;
	//Saliency
	var sal_div = document.createElement("div");
	details.appendChild(sal_div);
	sal_div.innerHTML = "Saliency: "+ data.saliency;
	//Uncertainty
	var uncert_div = document.createElement("div");
	details.appendChild(uncert_div);
	uncert_div.innerHTML = "Uncertainty: " + data.uncertainty;
	//Schema data
	expand_schema_data(reg_details, data.??????????); //HERE DISPLAY CLASS + NAME (+ from and to if relation)
	//Delete button
	var del_button = document.createElement("button");
	reg_details.appendChild(del_button);
	del_button.innerHTML = "Delete Region";
	del_button.setAttribute("onclick","del_rgn("+ obj.id +")");
	//Reset onclick
	obj.setAttribute("onclick", "reduce_reg(this)");
};

/**
 * Show all perceptual schemas informations.
 */
function expand_schema_data(obj, schema){
	
};

/**
 * Show only region name.
 */
function reduce_schema(obj){
	var children = obj.children;
	for(var i=0; i<children.length; i++){
		if(children[i].className == "schema_details"){
			obj.removeChild(children[i])
			obj.setAttribute("onclick", "expand_reg(this)");
			break;
		};
	};
};

/**
 * Delete a region and its associated mask.
 */
function del_rgn(id){
	var rgn = document.getElementById(id);
	var mask = document.getElementById(reg2mask[id]);
	delete reg2mask[id];
	delete mask2reg[mask.id];
	scene.regions.splice(id,1);
	rgn.remove();
	mask.remove();
	dispRegions();
}
//////////////////////////////////////
///Handling region masks on image///
//////////////////////////////////////
/**
* Draw a mask
* @param {canvas element} canvas.
*/
function initDraw(canvas) {
    function setMousePosition(e) {
        var ev = e || window.event; //Moz || IE
        if (ev.pageX) { //Moz
            mouse.x = ev.pageX + window.pageXOffset;
            mouse.y = ev.pageY + window.pageYOffset;
        } else if (ev.clientX) { //IE
            mouse.x = ev.clientX + document.body.scrollLeft;
            mouse.y = ev.clientY + document.body.scrollTop;
        }
    };

    var mouse = {
        x: 0,
        y: 0,
        startX: 0,
        startY: 0
    };
    var element = null;

    canvas.onmousemove = function (e) {
        setMousePosition();
        if (element !== null) {
            element.style.width = Math.abs(mouse.x - mouse.startX) + 'px';
            element.style.height = Math.abs(mouse.y - mouse.startY) + 'px';
            element.style.left = (mouse.x - mouse.startX < 0) ? mouse.x + 'px' : mouse.startX + 'px';
            element.style.top = (mouse.y - mouse.startY < 0) ? mouse.y + 'px' : mouse.startY + 'px';
        }
    }

    canvas.onclick = function (e) {
        if (element !== null) {
			var img_rect = document.getElementById("scene_img").getBoundingClientRect();
			var rect = element.getBoundingClientRect();
			update_form(Math.round((rect.top-img_rect.top)/scale), Math.round((rect.left-img_rect.left)/scale), Math.round(rect.width/scale), Math.round(rect.height/scale));
            element = null;
            canvas.style.cursor = "default";
            console.log("finsihed.");
        } else {
			$('.rectangle').remove();
            console.log("begun.");
            mouse.startX = mouse.x;
            mouse.startY = mouse.y;
            element = document.createElement('div');
            element.className = 'rectangle';
			element.id = 'rectangle_' + scene["regions"].length;
            element.style.left = mouse.x + 'px';
            element.style.top = mouse.y + 'px';
            canvas.appendChild(element)
            canvas.style.cursor = "crosshair";
        }
    }
}

/**
* Display the region masks for all the regions currently defined in scene.regions array.
*/
function disp_masks(){
	$('.mask').remove(); // Start by deleting all the existing masks.
	var scene_pic = document.getElementById("scene_pic");
	var img = document.getElementById("scene_img");
	var img_rect = img.getBoundingClientRect();
	
	for(var i=0; i<scene.regions.length; i++){
		var region = scene.regions[i];
		var mask = document.createElement("div");
		mask.setAttribute("class", "mask");
		mask.setAttribute("id", "mask_" + i);
		scene_pic.appendChild(mask);
		reg2mask[i] = "mask_" + i; //Setting a correspondence table between reg id and mask id.
		mask2reg["mask_" + i] = i;
		
		var loc = region.location;
		var size = region.size;
		mask.style.position = "absolute";
		mask.style.top = img_rect.top + loc[0]*scale + "px";
		mask.style.left = img_rect.left + loc[1]*scale + "px";
		mask.style.width = size[0]*scale + "px";
		mask.style.height = size[1]*scale + "px";
		mask.setAttribute("onclick", "area_reg_expand(this, mask2reg[this.id])");
		mask.setAttribute("onmouseover", "highlight_area(this.id)");
		mask.setAttribute("onmouseout", "reduce_reg(document.getElementById(mask2reg[this.id]))");
		mask.setAttribute("onmouseout", "dim_area(this.id)");
	};
};

/**
* Highlight mask and region when mouse over.
*/
function highlight_area(id){
	var myMask = document.getElementById(id);
	myMask.setAttribute("class", "highlight_mask");
	var myReg = document.getElementById(mask2reg[id]);
	myReg.setAttribute("class", "highlight_reg");
};

/**
* Dims mask and region when mouse out.
*/
function dim_area(id){
var myMask = document.getElementById(id);
	myMask.setAttribute("class", "mask");
	var myReg = document.getElementById(mask2reg[id]);
	myReg.setAttribute("class", "reg");
};

/**
* If region not expanded, expand region info when mask is clicked.
*/
function area_reg_expand(obj, id){
	reduce_reg(document.getElementById(id));
	expand_reg(document.getElementById(id));
	obj.setAttribute("onclick", "area_reg_reduce(this, mask2reg[this.id])");
};

/**
* If region expanded, reduce region info when mask is clicked.
*/
function area_reg_reduce(obj, id){
	reduce_reg(document.getElementById(id));
	obj.setAttribute("onclick", "area_reg_expand(this, mask2reg[this.id])");
};

function save_region(rgn_data){
	var rect = document.getElementById('rectangle_' + scene["regions"].length)
	if(rect) {
	 rect.remove();
		scene['regions'].push(rgn_data);
		dispRegions();
	}
	else{
		scene['regions'].push(rgn_data);
		dispRegions();
	}
}

///////////////////
///Handling form///
///////////////////
/**
* Update form x, y, w, h values based on the mask being drawn.
*/
function update_form(startX, startY, width, height){
	document.getElementById("x_Field").setAttribute("value", startX);
	document.getElementById("y_Field").setAttribute("value", startY);
	document.getElementById("width_Field").setAttribute("value", width);
	document.getElementById("height_Field").setAttribute("value", height);
};

/**
* Adds new perceptual schema to form.
* Offers the option to create either an object (OBJ) or relation (REL) perceptual schema.
*/
SCHEMA_COUNT=0;
function add_schemas(schema_type){
	// Define the content of an OBJ or REL schema
	var  obj_field = '{"name" : "A_NAME_' + SCHEMA_COUNT + '", "type" : "OBJ", "concept" : "A_CONCEPT"}';
	var  rel_field = '{"name" : "A_NAME_' + SCHEMA_COUNT + '", "type" : "REL", "concept" : "A_CONCEPT", "from" : "ORIGIN", "to" : "TARGET"}';
	
	// Add HTML content to the form.
	var schema_id  = "schema_" + SCHEMA_COUNT;
	var schemas_field = document.getElementById("schemas");
	var new_schema_div = document.createElement("div");
	new_schema_div.setAttribute("id", schema_id);
	schemas_field.appendChild(new_schema_div);
	
	var schema_label = document.createElement("label");
	schema_label.setAttribute("class", "field");
	schema_label.setAttribute("for", "schemas_Field[]");
	new_schema_div.appendChild(schema_label);
	
	var schema_textarea = document.createElement("textarea");
	schema_textarea.setAttribute("name", "schemas_Field[]");
	if(schema_type == "OBJ"){
		schema_textarea.innerHTML = obj_field;
	}
	if(schema_type == "REL"){
		schema_textarea.innerHTML = rel_field;
	}
	new_schema_div.appendChild(schema_textarea);
	
	var del_button = document.createElement("button");
	del_button.setAttribute("onclick", "del_schemas('" + schema_id + "')");
	del_button.innerHTML = "DEL";
	new_schema_div.appendChild(del_button);
	SCHEMA_COUNT += 1;
};

/**
* Delete a perceptual schema.
*/
function del_schemas(id){
	var obj = document.getElementById(id);
	obj.remove();
};

/**
* Adds all the schemas to perceive field
*/
function get_all_schemas(){
	var schemas = $("textarea[name='schemas_Field\\[\\]']")
				.map(function(){return $(this).val();}).get();
	
	var perceive_data = [];
	for(var i=0; i<schemas.length; i++){
		var schema = jQuery.parseJSON(schemas[i]);
		perceive_data.push('"' + schema.name + '"');
	}
	var perceive_field = document.getElementById("perceive_Field");
	perceive_field.setAttribute("value", '[' + perceive_data.join(', ') + ']');
};

/**
* Form submit function.
*/
function submit_form_data(){
    // This will act when the submit BUTTON is clicked
    $("#formToSave").submit(function(event){
        event.preventDefault();
        var rgn_data = buildData();
		save_region(rgn_data)
		reset_form();
    });
};

/**
* Reset form
*/
function reset_form(){
	$("#formToSave").replaceWith(form_clone.clone());
}

//////////////////
///Data handing///
//////////////////
/**
* This will generate the text file content based on the form data
*/
function buildData(){
    var data = {};
	data["name"] = $("#rgn_nameField").val();
	data["location"] = [Math.round($("#x_Field").val()), Math.round($("#y_Field").val())];
	data["size"] = [Math.round($("#width_Field").val()), Math.round($("#height_Field").val())];
    data["saliency"] = $("#saliency_Field").val();
	data["uncertainty"] = $("#uncertainty_Field").val();
	var schemas = $("textarea[name='schemas_Field\\[\\]']")
				.map(function(){return $(this).val();}).get();
	data["schemas"] = [];
	for(var i=0; i<schemas.length; i++){
		data["schemas"].push(jQuery.parseJSON(schemas[i]));
	}
	data["perceive"] = jQuery.parseJSON($("#perceive_Field").val());
	data["update"] = $("#update_Field").val();
    return data;
};

/**
* Allow user to download the data in JSON format.
*/
function generate_data(){
	var myScene = {"scene": scene};
	var data = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(myScene, null, ' '));
	$('<a href="data:' + data + '" download="TCG_scene.json" onclick="delete_save(this)">download JSON</a>').appendTo('#save_data');
};

function delete_save(obj){
	obj.remove();
}

/**
* Reset scene
*/
function reset_scene(){
	reset_form();
	img_rect = {};
	scene.regions = [];
	dispRegions();
}
</script>

</body>
</html>